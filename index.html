<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Trick to the Future通往未来的吃墩</title>
    
    <style>
        /* 引入 Digital-7 字体 */
        @import url('https://fonts.cdnfonts.com/css/digital-7-mono');
        /* 引入界面UI字体 */
        @import url('https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;700&display=swap');

        :root {
            --yellow: #f1c40f;
            --brown: #8d6e63;
            --blue: #3498db;
            --purple: #9b59b6;
            --bg-color: #202c39;
            --text-color: #ecf0f1;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            /* 兼容性高度设置 */
            height: 100vh; 
            height: 100dvh; 
            overflow: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .digital-font {
            font-family: 'Digital-7 Mono', monospace;
            letter-spacing: 1px;
            font-style: italic;
        }

        /* --- Start Screen --- */
        #start-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(32, 44, 57, 0.98);
            z-index: 1000; /* 最高层级，确保不被遮挡 */
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto; /* 防止内容过多无法点击 */
        }

        h1 { 
            font-family: 'Digital-7 Mono', sans-serif;
            margin-bottom: 1rem; 
            text-transform: uppercase; 
            text-align: center; 
            color: var(--yellow);
            font-size: 2.2rem;
            line-height: 1.4;
            font-style: italic;
        }

        .rules-box {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            width: 90%;
            max-width: 400px;
            max-height: 35vh;
            overflow-y: auto;
            margin-bottom: 20px;
            font-size: 0.85rem;
            line-height: 1.5;
            color: #bdc3c7;
        }
        .rules-box strong { color: var(--blue); }
        .rules-box ul { padding-left: 20px; margin: 5px 0; }

        .btn-group { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; width: 100%; }
        
        .start-btn {
            font-family: 'Digital-7 Mono', sans-serif;
            padding: 15px 30px;
            font-size: 1.4rem;
            cursor: pointer;
            background: var(--blue);
            border: none;
            color: white;
            border-radius: 6px;
            box-shadow: 0 4px 0 #1f618d;
            transition: transform 0.1s;
            font-style: italic;
            font-weight: bold;
            min-width: 80px;
        }
        .start-btn:active { transform: translateY(3px); box-shadow: none; }

        /* --- Game Area --- */
        #game-area {
            display: none;
            flex-direction: column;
            height: 100%;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            position: relative;
            padding-bottom: env(safe-area-inset-bottom, 20px); 
            box-sizing: border-box;
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: rgba(0,0,0,0.2);
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        #opponents-area {
            display: flex;
            gap: 10px;
            padding: 5px 10px;
            overflow-x: auto;
            white-space: nowrap;
            scrollbar-width: none;
            min-height: 75px; 
            align-items: center;
            flex-shrink: 0;
        }
        #opponents-area::-webkit-scrollbar { display: none; }

        .opponent-card {
            background: rgba(255,255,255,0.08);
            padding: 5px 8px;
            border-radius: 6px;
            min-width: 85px;
            text-align: center;
            border: 1px solid transparent;
            font-size: 0.75rem;
            flex-shrink: 0;
        }
        .opponent-card.active-turn {
            border-color: var(--yellow);
            background: rgba(241, 196, 15, 0.15);
        }

        .table-area {
            flex-grow: 1;
            background: rgba(0,0,0,0.2);
            margin: 5px 10px;
            border-radius: 10px;
            border: 1px dashed #555;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .played-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 6px;
            position: relative;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .played-card .player-label {
            position: absolute;
            top: -20px;
            font-size: 0.7rem;
            color: #bdc3c7;
            width: 80px;
            text-align: center;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        .fuel-cost-badge {
            position: absolute;
            bottom: -8px; right: -8px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 20px; height: 20px;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.8rem; font-weight: bold; font-family: 'Digital-7 Mono', sans-serif;
            z-index: 10;
        }
        
        .rotated-badge {
            position: absolute;
            top: 2px; right: 2px;
            color: #f1c40f;
            font-size: 0.8rem;
            font-weight: bold;
            text-shadow: 1px 1px 0 #000;
        }

        #player-dashboard {
            background: rgba(40, 50, 60, 0.95);
            padding: 10px;
            padding-bottom: 25px; 
            border-radius: 15px 15px 0 0;
            border-top: 2px solid #2ecc71;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
            z-index: 50;
            flex-shrink: 0;
            margin-bottom: 0;
        }

        .dash-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; font-size: 0.9rem; }
        .dash-stats { display: flex; gap: 10px; font-size: 0.8rem; color: #bdc3c7; margin-bottom: 8px; }
        .fuel-board { display: flex; gap: 3px; }
        .fuel-slot { width: 10px; height: 18px; border: 1px solid #7f8c8d; border-radius: 2px; background: rgba(0,0,0,0.4); }
        .fuel-slot.filled { background: #e67e22; border-color: #d35400; box-shadow: 0 0 4px #e67e22; }

        .hand { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }

        .card {
            width: 48px; height: 75px;
            border-radius: 6px;
            display: flex; 
            flex-direction: column;
            justify-content: center; 
            align-items: center;
            position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.4); border: 2px solid rgba(255,255,255,0.8);
            background-color: #95a5a6; transition: transform 0.1s;
        }

        .card-main-num {
            font-family: 'Digital-7 Mono', monospace; 
            font-size: 2.4rem;
            font-weight: 400;
            line-height: 1;
            margin-top: 4px;
            font-style: italic;
        }

        .card-hints {
            font-size: 0.65rem;
            color: #f1c40f; 
            font-family: sans-serif;
            font-weight: bold;
            margin-top: 2px;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.8);
            height: 12px;
            line-height: 12px;
        }

        .suit-Yellow { background: var(--yellow); color: #2c3e50; border-color: #f39c12;}
        .suit-Brown { background: var(--brown); color: white; border-color: #6d4c41;}
        .suit-Blue { background: var(--blue); color: white; border-color: #2980b9;}
        .suit-Purple { background: var(--purple); color: white; border-color: #8e44ad; box-shadow: 0 0 5px var(--purple);}

        .suit-icon { position: absolute; top: 2px; left: 3px; font-size: 0.6rem; font-family: sans-serif; opacity: 0.8; }
        
        .original-val-marker {
            position: absolute;
            bottom: 2px;
            right: 3px;
            font-size: 0.5rem;
            font-family: sans-serif;
            opacity: 0.8;
            color: rgba(255,255,255,0.8);
            background: rgba(0,0,0,0.5);
            padding: 0 2px;
            border-radius: 2px;
        }

        .suit-Yellow .card-main-num { color: #2c3e50; }
        .suit-Yellow .card-hints { color: #000; text-shadow: none; }
        .suit-Brown .card-main-num, .suit-Blue .card-main-num, .suit-Purple .card-main-num { color: white; }

        .hand .card:active { transform: scale(0.95); }
        .hand .card.disabled { opacity: 0.3; filter: grayscale(0.8); pointer-events: none; }

        #toast {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8); color: #fff; padding: 10px 20px;
            border-radius: 20px; font-size: 0.9rem; pointer-events: none;
            opacity: 0; transition: opacity 0.3s; z-index: 150; text-align: center; white-space: nowrap;
        }

        /* --- Modification Modal --- */
        #modal-overlay {
            display: none;
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: transparent;
            z-index: 90;
            justify-content: center;
            align-items: flex-end;
            padding-bottom: 20px;
            pointer-events: none;
        }

        .modal-content {
            pointer-events: auto;
            background: rgba(30, 40, 50, 0.9);
            backdrop-filter: blur(8px);
            padding: 10px 15px;
            border-radius: 12px;
            width: 90%;
            max-width: 350px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 -5px 25px rgba(0,0,0,0.6);
            margin-bottom: 160px; 
        }

        .modal-content h3 { margin: 0 0 5px 0; font-size: 0.9rem; color: var(--yellow); }
        .modal-content p { font-size: 0.75rem; margin: 0 0 8px 0; color: #ccc; }

        .options-grid {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 8px;
            margin-bottom: 10px; max-height: 150px; overflow-y: auto;
        }

        .option-card {
            background: rgba(255,255,255,0.1); padding: 5px 10px; border-radius: 5px;
            cursor: pointer; border: 1px solid rgba(255,255,255,0.2); min-width: 50px;
        }
        
        .option-val { font-family: 'Digital-7 Mono', sans-serif; font-size: 1.5rem; font-weight: bold; font-style: italic;}

        .cancel-btn { background: rgba(231, 76, 60, 0.8); padding: 8px; font-size: 0.8rem; width: 100%; }

        /* --- Overlays --- */
        #game-over-screen, #round-end-screen {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 300;
        }
        #game-over-screen { background: rgba(32, 44, 57, 0.98); }
        #round-end-screen { background: rgba(0, 0, 0, 0.5); }

        .round-end-modal {
            background: rgba(32, 44, 57, 0.95);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid var(--blue);
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            width: 90%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .score-list { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        .score-list tr { border-bottom: 1px solid rgba(255,255,255,0.1); }
        .score-list td { padding: 8px 5px; font-size: 0.9rem; }
        
        .col-name { text-align: left; width: 25%; font-weight: bold; }
        .col-stats { text-align: center; width: 55%; color: #bdc3c7; }
        .col-score { text-align: right; width: 20%; font-family: 'Digital-7 Mono'; font-size: 1.3rem; font-style: italic;}

        .status-badge { 
            font-size: 0.7rem; padding: 1px 4px; border-radius: 3px; 
            margin-left: 5px; white-space: nowrap; display: inline-block;
        }
        .st-perfect { background: #2ecc71; color: #fff; }
        .st-success { background: #3498db; color: #fff; }
        .st-fail { background: #e74c3c; color: #fff; }

    </style>
</head>
<body>

    <!-- Start Screen -->
    <div id="start-screen">
        <h1>Trick to the<br>Future</h1>
        
        <div class="rules-box">
            <div style="text-align:center; margin-bottom:10px; font-weight:bold; color:var(--yellow);">游戏规则</div>
            <strong>目标：</strong> 控制赢得的墩数与手里的燃料棒数量相符。<br>
            <strong>花色：</strong> 黄色(过去)、棕色(现在)、蓝色(未来)、<span style="color:var(--purple)">紫色(王牌)</span>。<br>
            <strong>修改数值：</strong> 出牌时可消耗燃料棒或旋转卡牌来改变数字大小。<br>
            <strong>计分：</strong>
            <ul>
                <li><span style="color:#2ecc71">完美之旅</span>: 墩数 = 燃料 (4分/墩) (2分/燃料棒)</li>
                <li><span style="color:#3498db">成功之旅</span>: 燃料 > 墩数 (2分/墩) (1分/燃料棒)</li>
                <li><span style="color:#e74c3c">迷失时间</span>: 燃料 < 墩数 (0分)</li>
                <li><span style="color:#e74c3c">时光机失灵</span>: 0 墩 (每有1个空置的燃料槽+3分)</li>
            </ul>
        </div>

        <p style="margin-bottom: 10px; font-size: 0.9rem; opacity: 0.8;">请选择玩家人数</p>
        <div class="btn-group">
            <button class="start-btn" onclick="initGame(2)">2 人</button>
            <button class="start-btn" onclick="initGame(3)">3 人</button>
            <button class="start-btn" onclick="initGame(4)">4 人</button>
            <button class="start-btn" onclick="initGame(5)">5 人</button>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="game-area">
        <div class="game-header">
            <div id="round-info" class="digital-font" style="color:var(--yellow)">R 1/3</div>
            <div id="trump-info" style="color:var(--purple); font-size:0.8rem; font-weight:bold;">王牌:超越</div>
        </div>

        <!-- AI Opponents -->
        <div id="opponents-area"></div>

        <!-- Table Area -->
        <div class="table-area" id="table-area">
            <div style="color: rgba(255,255,255,0.3); font-size: 0.9rem;">等待出牌...</div>
        </div>

        <!-- Player Dashboard -->
        <div id="player-dashboard">
            <div class="dash-header">
                <strong style="color: #2ecc71;">玩家 (你)</strong>
                <div style="display:flex; align-items:center; gap:5px;">
                    <div class="fuel-board" id="player-fuel-display"></div>
                    <span class="digital-font" id="player-fuel-text" style="color:#e67e22; font-size:1rem;">0</span>
                </div>
            </div>
            <div class="dash-stats">
                <span>墩: <b id="player-tricks" style="color:white;">0</b></span>
                <span>抢得燃料棒: <b id="player-collected" style="color:white;">0</b></span>
                <span style="margin-left:auto">总分: <b id="player-score" style="color:#f1c40f;">0</b></span>
            </div>
            <div class="hand" id="player-hand"></div>
        </div>
        
        <!-- Toast Notification -->
        <div id="toast">提示信息</div>

        <!-- Round End Overlay -->
        <div id="round-end-screen">
            <div class="round-end-modal">
                <h2 style="color:var(--yellow); margin-bottom:15px; margin-top:0;" class="digital-font">任务报告</h2>
                <div id="round-scores-container" style="width:100%"></div>
                <button class="start-btn" onclick="nextRound()" style="margin-top:15px; background:#2ecc71; font-size:1rem;">下一轮</button>
            </div>
        </div>
    </div>

    <!-- Modification Modal -->
    <div id="modal-overlay">
        <div class="modal-content">
            <h3>修改数值</h3>
            <p>选择结果 (消耗燃料棒)</p>
            <div class="options-grid" id="modal-options"></div>
            <button class="cancel-btn" onclick="closeModal()">取消</button>
        </div>
    </div>
    
    <!-- Game Over Screen -->
    <div id="game-over-screen">
        <h1 id="game-result-title">游戏结束</h1>
        <div id="final-scores" style="margin-bottom: 30px; width: 90%; display:flex; justify-content:center;"></div>
        <button class="start-btn" onclick="location.reload()">再来一局</button>
    </div>

    <script>
        const SUITS = ['Yellow', 'Brown', 'Blue', 'Purple'];
        const SUIT_NAMES = { 'Yellow': '过去', 'Brown': '现在', 'Blue': '未来', 'Purple': '超越' };
        
        let gameState = {
            numPlayers: 0,
            players: [],
            round: 1,
            deck: [],
            currentTurnIndex: 0,
            tableCards: [], 
            trickStarterSuit: null,
            phase: 'START',
            isProcessingAI: false
        };

        class Card {
            constructor(suit, value) {
                this.suit = suit;
                this.value = value;
            }
        }

        class Player {
            constructor(id, isHuman) {
                this.id = id;
                this.isHuman = isHuman;
                this.name = isHuman ? "你" : `电脑${id}`;
                this.hand = [];
                this.fuel = 0;
                this.tricksWon = 0;
                this.collectedRods = 0;
                this.totalScore = 0;
                this.lastRoundScore = 0;
            }
        }

        function getCardOptions(val) {
            let opts = [{ n:val, c:0, r:false }];
            switch(val) {
                case 0: opts.push({ n:8, c:1 }); break;
                // 1->9 cost is 4 
                case 1: opts.push({ n:7, c:1 }, { n:3, c:3 }, { n:6, c:2 }, { n:8, c:5 }, { n:9, c:4 }); break;
                case 2: opts.push({ n:8, c:2 }); break;
                case 3: opts.push({ n:6, c:1, r:true }, { n:9, c:1 }, { n:8, c:2 }); break;
                case 4: opts.push({ n:6, c:1, r:true }, { n:9, c:1 }, { n:8, c:3 }); break;
                case 5: opts.push({ n:6, c:1 }, { n:8, c:2 }, { n:9, c:1 }); break;
                case 6: opts.push({ n:9, c:0, r:true }, { n:8, c:1 }); break;
                case 7: opts.push({ n:3, c:2 }, { n:6, c:1, r:true }, { n:8, c:4 }, { n:9, c:3 }); break;
                case 8: break; 
                case 9: opts.push({ n:6, c:0, r:true }, { n:8, c:1 }); break;
            }
            return opts.map(o => ({ newValue: o.n, cost: o.c, rotate: o.r || false }));
        }

        function initGame(n) {
            gameState.numPlayers = n;
            gameState.players = [new Player(0, true)];
            for(let i=1; i<n; i++) gameState.players.push(new Player(i, false));
            
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('game-area').style.display = 'flex';
            startRound();
        }

        function buildDeck() {
            let deck = [];
            SUITS.forEach(s => { for(let v=0; v<=9; v++) deck.push(new Card(s, v)); });
            const n = gameState.numPlayers;
            if (n===2) deck = deck.filter(c => c.suit!=='Purple' && ![4,7,8].includes(c.value));
            else if (n===3) deck = deck.filter(c => ![4,7,8].includes(c.value));
            else if (n===5) deck = deck.filter(c => !(c.suit==='Yellow' && c.value===1));
            return deck.sort(()=>Math.random()-0.5);
        }

        function startRound() {
            if (gameState.round > 3) return endGame();
            gameState.tableCards = [];
            gameState.trickStarterSuit = null;
            gameState.deck = buildDeck();
            
            let cN=0, fN=0;
            if (gameState.numPlayers===2) { cN=6; fN=6; }
            else if (gameState.numPlayers===3) { cN=8; fN=5; }
            else if (gameState.numPlayers===4) { cN=9; fN=6; }
            else if (gameState.numPlayers===5) { cN=7; fN=5; }

            gameState.players.forEach(p => {
                p.hand = gameState.deck.splice(0, cN).sort((a,b) => SUITS.indexOf(a.suit)-SUITS.indexOf(b.suit) || a.value-b.value);
                p.fuel = fN;
                p.tricksWon = 0;
                p.collectedRods = 0;
            });

            document.getElementById('round-info').textContent = `R ${gameState.round}/3`;
            determineStartPlayer();
            gameState.phase = 'PLAY';
            updateUI();
            checkTurn();
        }

        function determineStartPlayer() {
            let s = -1;
            for(let i=0; i<gameState.numPlayers; i++) {
                if(gameState.players[i].hand.some(c=>c.suit==='Yellow'&&c.value===0)) { s=i; break; }
            }
            if(s===-1 && gameState.numPlayers===2) {
                let min=100;
                gameState.players.forEach((p,i)=>{ p.hand.forEach(c=>{ if(c.suit==='Yellow'&&c.value<min){min=c.value;s=i;} }) });
            }
            gameState.currentTurnIndex = (s===-1) ? 0 : s;
            showToast(`${gameState.players[gameState.currentTurnIndex].name} 先手`);
        }

        function checkTurn() {
            if (gameState.phase !== 'PLAY') return;
            updateUI();
            const p = gameState.players[gameState.currentTurnIndex];
            if (!p.isHuman) {
                gameState.isProcessingAI = true;
                setTimeout(() => aiPlay(p), 1000);
            } else {
                gameState.isProcessingAI = false;
            }
        }

        let selectedIdx = -1;
        function handleHumanCardClick(idx) {
            if(gameState.phase!=='PLAY' || gameState.isProcessingAI) return;
            const p = gameState.players[0];
            const c = p.hand[idx];
            
            if (gameState.tableCards.length > 0) {
                const lead = gameState.trickStarterSuit;
                if (p.hand.some(x=>x.suit===lead) && c.suit!==lead) {
                    showToast("必须跟花色!");
                    return;
                }
            }
            selectedIdx = idx;
            const opts = getCardOptions(c.value).filter(o => o.cost <= p.fuel);
            if(opts.length===1 && opts[0].cost===0 && !opts[0].rotate) executePlay(p, idx, opts[0]);
            else showModal(opts);
        }

        function showModal(opts) {
            const el = document.getElementById('modal-options');
            el.innerHTML = '';
            opts.forEach(o => {
                const div = document.createElement('div');
                div.className = 'option-card';
                div.innerHTML = `<div class="option-val" style="color:${o.rotate?'#f1c40f':'#ecf0f1'}">${o.rotate?'↻':''}${o.newValue}</div><div style="font-size:0.7rem; color:#e74c3c;">-${o.cost} 燃料棒</div>`;
                div.onclick = () => { closeModal(); executePlay(gameState.players[0], selectedIdx, o); };
                el.appendChild(div);
            });
            document.getElementById('modal-overlay').style.display = 'flex';
        }
        function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }

        function aiPlay(p) {
            let validIdx = p.hand.map((_,i)=>i);
            if (gameState.tableCards.length > 0) {
                const lead = gameState.trickStarterSuit;
                if (p.hand.some(c=>c.suit===lead)) validIdx = p.hand.map((c,i)=>c.suit===lead?i:-1).filter(i=>i!==-1);
            }
            
            // AI Logic
            const currentTricks = p.tricksWon;
            const currentFuel = p.fuel;
            const cardsRemaining = p.hand.length;
            let bestMove = null;
            let bestScore = -99999;

            validIdx.forEach(i => {
                const c = p.hand[i];
                const opts = getCardOptions(c.value).filter(o => o.cost <= p.fuel);

                opts.forEach(o => {
                    const cost = o.cost;
                    const finalValue = o.newValue;
                    const isRotated = o.rotate;
                    let willWin = false;
                    
                    if (gameState.tableCards.length === 0) {
                        if (c.suit === 'Purple') willWin = true; 
                        else if (finalValue >= 7) willWin = true;
                    } else {
                        let currentWinner = null;
                        let maxVal = -1;
                        const trumps = gameState.tableCards.filter(tc => tc.c.suit === 'Purple');
                        
                        if (trumps.length > 0) {
                            currentWinner = trumps.reduce((prev, curr) => curr.mod >= prev.mod ? curr : prev);
                            maxVal = currentWinner.mod;
                            if (c.suit === 'Purple') {
                                if (finalValue >= maxVal) willWin = true; 
                            } else {
                                willWin = false;
                            }
                        } else {
                            const lead = gameState.trickStarterSuit;
                            const leads = gameState.tableCards.filter(tc => tc.c.suit === lead);
                            if (leads.length > 0) {
                                currentWinner = leads.reduce((prev, curr) => curr.mod >= prev.mod ? curr : prev);
                                maxVal = currentWinner.mod;
                            }
                            if (c.suit === 'Purple') willWin = true; 
                            else if (c.suit === lead) {
                                if (finalValue >= maxVal) willWin = true;
                            } else willWin = false; 
                        }
                    }

                    const predictedFuel = currentFuel - cost;
                    const predictedTricks = currentTricks + (willWin ? 1 : 0);
                    const gap = predictedFuel - predictedTricks;
                    
                    let score = 0;
                    score -= Math.abs(gap) * 10; 

                    if (cardsRemaining <= 2) {
                        if (gap > 0 && cost > 0) score += cost * 50; 
                        if (gap < 0 && !willWin) score += 100; 
                        if (gap === 0) score += 500;
                    } 
                    else {
                        if (gap === 0 && willWin) score += 5;
                        if (gap > 0) score += cost * 2; 
                        else score -= cost * 1; 
                    }

                    if (cost === 0 && !isRotated) score += 1;
                    score += Math.random();

                    if (score > bestScore) {
                        bestScore = score;
                        bestMove = { i: i, opt: o };
                    }
                });
            });

            if (!bestMove) {
                bestMove = { i: validIdx[0], opt: { newValue: p.hand[validIdx[0]].value, cost: 0, rotate: false } };
            }

            executePlay(p, bestMove.i, bestMove.opt);
        }

        function executePlay(p, i, opt) {
            const c = p.hand.splice(i, 1)[0];
            p.fuel -= opt.cost;
            if(gameState.tableCards.length===0) gameState.trickStarterSuit = c.suit;
            
            gameState.tableCards.push({ pId: p.id, c, mod: opt.newValue, cost: opt.cost, rot: opt.rotate });
            updateUI();
            
            if(gameState.tableCards.length === gameState.numPlayers) setTimeout(resolveTrick, 800);
            else {
                gameState.currentTurnIndex = (gameState.currentTurnIndex + 1) % gameState.numPlayers;
                checkTurn();
            }
        }

        function resolveTrick() {
            const cards = gameState.tableCards;
            let winObj = null;
            const trumps = cards.filter(x=>x.c.suit==='Purple');
            if(trumps.length>0) winObj = trumps.reduce((p,c)=>c.mod>=p.mod?c:p);
            else {
                const leads = cards.filter(x=>x.c.suit===gameState.trickStarterSuit);
                winObj = leads.reduce((p,c)=>c.mod>=p.mod?c:p);
            }
            
            const winner = gameState.players[winObj.pId];
            showToast(`${winner.name} 赢了! (+${cards.reduce((s,x)=>s+x.cost,0)}燃料棒)`);
            winner.tricksWon++;
            winner.collectedRods += cards.reduce((s,x)=>s+x.cost,0);
            
            gameState.tableCards = [];
            gameState.trickStarterSuit = null;
            gameState.currentTurnIndex = winner.id;
            updateUI();

            if(gameState.players[0].hand.length===0) setTimeout(scoreRound, 1000);
            else checkTurn();
        }

        function scoreRound() {
            const container = document.getElementById('round-scores-container');
            let tableHtml = '<table class="score-list">';
            
            gameState.players.forEach(p => {
                let s = 0;
                let status = "";
                let statusClass = "";
                let diff = p.fuel - p.tricksWon;
                
                if(p.tricksWon===0) { 
                    s = (6-p.fuel)*3; status="时光机失灵"; statusClass="st-fail"; 
                } else if(diff===0) { 
                    s = p.tricksWon*4 + p.collectedRods*2; status="完美"; statusClass="st-perfect"; 
                } else if(diff>0) { 
                    s = p.tricksWon*2 + p.collectedRods; status="成功"; statusClass="st-success"; 
                } else { 
                    s = 0; status="迷失"; statusClass="st-fail"; 
                }
                
                p.totalScore += s;
                p.lastRoundScore = s;
                
                tableHtml += `
                    <tr>
                        <td class="col-name" style="color:${p.isHuman?'#2ecc71':'#ccc'}">${p.name}</td>
                        <td class="col-stats">
                            ${p.tricksWon}墩 / ${p.fuel}剩余燃料棒<br>
                            <span class="status-badge ${statusClass}">${status}</span>
                        </td>
                        <td class="col-score" style="color:${s>0?'#2ecc71':'#e74c3c'}">+${s}</td>
                    </tr>
                `;
            });
            tableHtml += '</table>';
            container.innerHTML = tableHtml;
            document.getElementById('round-end-screen').style.display = 'flex';
        }

        function nextRound() {
            gameState.round++;
            document.getElementById('round-end-screen').style.display = 'none';
            startRound();
        }

        function endGame() {
            document.getElementById('game-area').style.display = 'none';
            document.getElementById('round-end-screen').style.display = 'none';
            document.getElementById('game-over-screen').style.display = 'flex';
            
            gameState.players.sort((a,b) => (b.totalScore - a.totalScore) || (b.lastRoundScore - a.lastRoundScore));
            
            let h = '<table class="score-list">';
            gameState.players.forEach(p => {
                h += `<tr><td style="padding:10px; color:${p.isHuman?'#2ecc71':'#ccc'}">${p.name}</td><td style="font-size:1.5rem; font-family:'Digital-7 Mono'; font-style:italic; text-align:right;">${p.totalScore}</td></tr>`;
            });
            h += '</table>';
            document.getElementById('final-scores').innerHTML = h;
            document.getElementById('game-result-title').innerText = gameState.players[0].isHuman ? "你赢了!" : "再接再厉";
        }

        function updateUI() {
            // Opponents
            const oppArea = document.getElementById('opponents-area');
            oppArea.innerHTML = '';
            for(let i=1; i<gameState.numPlayers; i++) {
                const p = gameState.players[i];
                const active = gameState.currentTurnIndex===i && gameState.phase==='PLAY';
                let dots = '';
                for(let k=0;k<6;k++) dots+=`<span style="display:inline-block;width:4px;height:8px;margin:1px;background:${k<p.fuel?'#e67e22':'#555'}"></span>`;
                
                oppArea.innerHTML += `
                    <div class="opponent-card ${active?'active-turn':''}">
                        <div>${p.name}</div>
                        <div style="display:flex; justify-content:center; align-items:center; gap:3px;">
                            <span style="font-family:'Digital-7 Mono'; font-style:italic; color:#e67e22; font-weight:bold;">${p.fuel}</span>
                            <div style="display:flex;">${dots}</div>
                        </div>
                        <div style="margin-top:2px; font-size:0.7rem;">牌:${p.hand.length} 墩:${p.tricksWon} 棒:${p.collectedRods}</div>
                    </div>`;
            }

            // Table
            const tbl = document.getElementById('table-area');
            if(gameState.tableCards.length===0) tbl.innerHTML = '<div style="color:rgba(255,255,255,0.3); font-size:0.8rem;">等待出牌...</div>';
            else {
                tbl.innerHTML = '';
                gameState.tableCards.forEach(o => {
                    const p = gameState.players[o.pId];
                    const showOriginal = !o.rot && (o.mod !== o.c.value);

                    tbl.innerHTML += `
                        <div class="played-card">
                            <div class="player-label" style="color:${p.isHuman?'#2ecc71':'#bdc3c7'}">${p.name}</div>
                            <div class="card suit-${o.c.suit}">
                                <div class="card-main-num">${o.mod}</div>
                                ${showOriginal ? `<span class="original-val-marker">(${o.c.value})</span>` : ''}
                                ${o.rot ? `<span class="rotated-badge">↻</span>` : ''}
                            </div>
                            ${o.cost>0 ? `<div class="fuel-cost-badge">-${o.cost}</div>` : ''}
                        </div>`;
                });
            }

            // Player
            const human = gameState.players[0];
            const dash = document.getElementById('player-dashboard');
            dash.style.borderColor = (gameState.currentTurnIndex===0 && gameState.phase==='PLAY') ? '#2ecc71' : '#34495e';
            
            document.getElementById('player-fuel-text').innerText = human.fuel;
            let fHtml = ''; for(let i=0;i<6;i++) fHtml+=`<div class="fuel-slot ${i<human.fuel?'filled':''}"></div>`;
            document.getElementById('player-fuel-display').innerHTML = fHtml;
            document.getElementById('player-tricks').innerText = human.tricksWon;
            document.getElementById('player-collected').innerText = human.collectedRods;
            document.getElementById('player-score').innerText = human.totalScore;

            const handEl = document.getElementById('player-hand');
            handEl.innerHTML = '';
            human.hand.forEach((c, idx) => {
                let dim = '';
                let click = (gameState.currentTurnIndex===0 && gameState.phase==='PLAY');
                if(click && gameState.tableCards.length>0) {
                    const l = gameState.trickStarterSuit;
                    if(human.hand.some(x=>x.suit===l) && c.suit!==l) { dim='disabled'; click=false; }
                }
                if(!click && gameState.phase==='PLAY' && gameState.currentTurnIndex!==0) dim='opacity:0.5';
                
                // Hints logic
                const allOpts = getCardOptions(c.value);
                const potentialVals = [...new Set(allOpts.filter(o => o.newValue !== c.value).map(o => o.newValue))].sort((a,b)=>a-b);
                const hintStr = potentialVals.join(',');

                // Use safer string concatenation for onclick
                handEl.innerHTML += `
                    <div class="card suit-${c.suit} ${dim}" onclick="${click ? 'handleHumanCardClick(' + idx + ')' : ''}">
                        <span class="suit-icon">${SUIT_NAMES[c.suit]}</span>
                        <div class="card-main-num">${c.value}</div>
                        ${hintStr ? `<div class="card-hints">${hintStr}</div>` : `<div class="card-hints"></div>`}
                    </div>`;
            });
        }

        let toastTimeout;
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.opacity = 1;
            clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => t.style.opacity = 0, 2000);
        }
    </script>
</body>
</html>